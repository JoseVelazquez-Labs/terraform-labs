
############################################################
# ğŸ§  1ï¸âƒ£ Â¿QuÃ© es un â€œproviderâ€?
#
# Un *provider* (proveedor) es el â€œconectorâ€ entre Terraform y un servicio.
# Ejemplo: si quieres crear recursos en Azure o AWS, necesitas su provider.
#
# Cada provider sabe cÃ³mo comunicarse con la API del servicio.
# Sin provider, Terraform no puede crear ni modificar nada.
############################################################


############################################################
# âš™ï¸ 2ï¸âƒ£ BLOQUE TERRAFORM â†’ â€œrequired_providersâ€
#
# AquÃ­ indicamos QUÃ‰ proveedores usaremos y sus versiones.
# Terraform descargarÃ¡ automÃ¡ticamente esos providers desde el
# registro oficial (registry.terraform.io).
############################################################

terraform {
  required_version = ">= 1.5.0" # (Opcional, pero recomendable)

  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm" # Azure Resource Manager
      version = "~> 3.100"          # Usa la versiÃ³n 3.x mÃ¡s reciente
    }

    aws = {
      source  = "hashicorp/aws"     # Amazon Web Services
      version = "~> 5.60"
    }

    kubernetes = {
      source  = "hashicorp/kubernetes" # Para clusters K8s
      version = "~> 2.33"
    }
  }
}


############################################################
# â˜ï¸ 3ï¸âƒ£ CONFIGURAR UN PROVIDER
#
# Una vez declarado, debemos â€œconfigurarloâ€.
# AquÃ­ se definen credenciales, regiÃ³n o suscripciÃ³n, etc.
# Normalmente los datos sensibles se guardan en variables o
# se leen desde el entorno (no se escriben directamente).
############################################################

# ğŸ”¹ Azure Provider
provider "azurerm" {
  features {}  # Siempre obligatorio (aunque estÃ© vacÃ­o)
  subscription_id = var.azure_subscription_id
  tenant_id       = var.azure_tenant_id
  use_msi         = false # MSI es otra forma de autenticaciÃ³n en Azure
}

# ğŸ”¹ AWS Provider
provider "aws" {
  region  = var.aws_region   # Ejemplo: "eu-west-1"
  profile = var.aws_profile  # Si tienes varios perfiles AWS configurados
}

# ğŸ”¹ Kubernetes Provider
provider "kubernetes" {
  host                   = var.kube_host
  cluster_ca_certificate = base64decode(var.kube_ca)
  token                  = var.kube_token
}


############################################################
# ğŸ§© 4ï¸âƒ£ VARIAS CONFIGURACIONES DEL MISMO PROVIDER (ALIAS)
#
# Puedes usar el mismo provider varias veces.
# Ejemplo: trabajar en dos regiones o cuentas distintas de AWS.
############################################################

# Dos configuraciones distintas de AWS
provider "aws" {
  alias  = "eu"
  region = "eu-west-1"
}

provider "aws" {
  alias  = "us"
  region = "us-east-1"
}

# Usamos los alias en los recursos:
resource "aws_s3_bucket" "logs_eu" {
  provider = aws.eu
  bucket   = "logs-eu-${random_id.suffix.hex}"
}

resource "aws_s3_bucket" "logs_us" {
  provider = aws.us
  bucket   = "logs-us-${random_id.suffix.hex}"
}

resource "random_id" "suffix" {
  byte_length = 3
}


############################################################
# ğŸ“¦ 5ï¸âƒ£ USO DE PROVIDERS EN MÃ“DULOS
#
# Cuando usas mÃ³dulos, cada uno puede tener sus propios providers.
# En el mÃ³dulo â€œpadreâ€, debes pasarle quÃ© configuraciÃ³n usar.
############################################################

# Ejemplo de mÃ³dulo â€œnetworkâ€
module "network" {
  source = "./modules/network"

  # Le indicamos quÃ© configuraciÃ³n del provider debe usar:
  providers = {
    aws.eu = aws.eu
    aws.us = aws.us
  }

  # Variables del mÃ³dulo (por ejemplo):
  # vpc_cidr = "10.0.0.0/16"
}


############################################################
# ğŸª£ 6ï¸âƒ£ ARCHIVO DE BLOQUEO (.terraform.lock.hcl)
#
# Terraform guarda un archivo automÃ¡tico con los providers y sus versiones.
# Este archivo asegura que todos los que usen el proyecto descarguen
# exactamente las mismas versiones (muy importante para equipos).
#
# âœ… No lo creas tÃº, lo genera Terraform al hacer â€œterraform initâ€.
# âœ… Debes subirlo a tu repositorio (Git) para mantener consistencia.
############################################################

# Ejemplo (no lo escribes tÃº):
# .terraform.lock.hcl
#   â”œâ”€â”€ Provider: hashicorp/aws = 5.60.0
#   â”œâ”€â”€ Provider: hashicorp/azurerm = 3.100.0
#   â””â”€â”€ Checksums: SHA256 validaciones


############################################################
# ğŸ” 7ï¸âƒ£ CREDENCIALES Y AUTENTICACIÃ“N
#
# Terraform puede usar muchas formas de autenticarse con cada servicio.
# La recomendada: usar credenciales externas (CLI, entorno, perfiles).
############################################################

# ğŸ”¹ En Azure:
#   - â€œaz loginâ€ desde terminal (Terraform detectarÃ¡ tu sesiÃ³n)
#   - Variables de entorno:
#       ARM_CLIENT_ID, ARM_CLIENT_SECRET, ARM_TENANT_ID, ARM_SUBSCRIPTION_ID
#   - Managed Identity: usa_msi = true

# ğŸ”¹ En AWS:
#   - Archivos de credenciales (~/.aws/credentials)
#   - Variables de entorno:
#       AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_SESSION_TOKEN
#   - Roles y SSO (inicio de sesiÃ³n con AWS CLI)

# ğŸ”¹ En Kubernetes:
#   - Archivo kubeconfig local: config_path y config_context
#   - Certificados y tokens (como en el ejemplo de arriba)


############################################################
# âš¡ 8ï¸âƒ£ INICIALIZAR E INSTALAR PROVIDERS
#
# El comando â€œterraform initâ€ descarga los providers necesarios.
# Usa â€œ-upgradeâ€ si quieres buscar versiones mÃ¡s nuevas dentro de tu rango.
############################################################

# terraform init          # Descarga los providers
# terraform init -upgrade # Actualiza los providers dentro de los lÃ­mites de versiÃ³n


############################################################
# ğŸª 9ï¸âƒ£ MIRRORS Y CACHÃ‰ (AVANZADO)
#
# Si trabajas en entornos sin Internet o empresariales, puedes crear
# un espejo local de providers. Esto se configura en el archivo del CLI,
# no en el cÃ³digo del proyecto.
############################################################

# Archivo: ~/.terraformrc  o  $TF_CLI_CONFIG_FILE
# Ejemplo:
# provider_installation {
#   filesystem_mirror {
#     path = "/opt/terraform/providers"
#   }
#   network_mirror {
#     url  = "https://internal.example.com/terraform"
#   }
#   direct {} # Permite descargar del registro pÃºblico si no hay espejo
# }


############################################################
# ğŸ’¡ 10ï¸âƒ£ BUENAS PRÃCTICAS CON PROVIDERS
############################################################
# âœ… Siempre fija versiones con â€œrequired_providersâ€.
# âœ… No uses â€œlatestâ€; eso rompe compatibilidad.
# âœ… Versiona el archivo â€œ.terraform.lock.hclâ€ en Git.
# âœ… Usa alias (provider â€œawsâ€ { alias = â€œprodâ€ }) para multi-regiÃ³n o multi-cuenta.
# âœ… MantÃ©n credenciales fuera del cÃ³digo (usa entorno o perfiles).
# âœ… Documenta cÃ³mo inicializar el proyecto (â€œterraform initâ€, etc.)
############################################################
